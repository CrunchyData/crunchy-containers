<!DOCTYPE html>
<html>
  <head>
    
    <title>Crunchy Data Container Suite Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.55.6" />
<title>pgBackRest :: Crunchy Data Container Suite Documentation</title>
<link rel="shortcut icon" href="https://crunchydata.github.io/crunchy-containers/4.7.7/favicon.png" type="image/x-icon" />
<link href="https://crunchydata.github.io/crunchy-containers/4.7.7/css/nucleus.css" rel="stylesheet">
<link href="https://crunchydata.github.io/crunchy-containers/4.7.7/theme-flex/style.css" rel="stylesheet">

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<link href="https://crunchydata.github.io/crunchy-containers/4.7.7/css/Fort-Fonts.css" rel="stylesheet">
<link href="https://crunchydata.github.io/crunchy-containers/4.7.7/css/custom.css" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
<script src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/jquery-2.x.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.bundle.min.js" integrity="sha384-zDnhMsjVZfS3hiP7oCBRmfjkQC4fzxVxFhBx8Hkz2aZX8gEvA/jsP3eXRCvzTofP" crossorigin="anonymous"></script>
<script src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/main.js"></script>
<script src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/toc.js"></script>
<script type="text/javascript">
      var baseurl = "https:\/\/crunchydata.github.io\/crunchy-containers\/4.7.7";
</script>
<meta name="description" content="">



    
  </head>
  <body data-url="/examples/backup-restoration/pgbackrest/">
    
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  
<a class="navbar-brand" href="https://www.crunchydata.com/"><img alt="Crunchy Data" src="https://crunchydata.github.io/crunchy-containers/4.7.7/images/logo.svg"></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <ul class="navbar-nav mr-auto"></ul>
  <span class="navbar-text">
      <nav class="shortcuts">
              <li class="" role="">
                  <a href="https://github.com/CrunchyData/crunchy-containers" target="_blank" rel="noopener">
                    <i class='fab fa-github'></i> <label>Source</label>
                  </a>
              </li>
              <li class="" role="">
                  <a href="https://kubernetes.io/docs/" target="_blank" rel="noopener">
                    <i class='fas fa-bookmark'></i> <label>Kubernetes</label>
                  </a>
              </li>
              <li class="" role="">
                  <a href="https://github.com/CrunchyData/crunchy-containers/blob/master/LICENSE.md" target="_blank" rel="noopener">
                    <i class='fas fa-file-contract'></i> <label>License</label>
                  </a>
              </li>
      </nav>
  </span>
</nav>

<article>
  <aside>

    <ul class="menu">
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="">
        </div>
        <script type="text/javascript" src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/lunr.min.js"></script>
        <script type="text/javascript" src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/auto-complete.js"></script>
        <link href="https://crunchydata.github.io/crunchy-containers/4.7.7/css/auto-complete.css" rel="stylesheet">
        <script type="text/javascript">
          
              var baseurl = "https:\/\/crunchydata.github.io\/crunchy-containers\/4.7.7";
          
        </script>
        <script type="text/javascript" src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/search.js"></script>
      </div>

      <hr>
      <a class="baselink" href="https://crunchydata.github.io/crunchy-containers/4.7.7/">Crunchy Data Container Suite Documentation</a>
      <hr>
        <b>Available Formats</b>
        <nav class="downloads">
                <li class="" role="">
                    <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/pdf/crunchy_containers.pdf" target="_blank" rel="noopener">
                      <i class='fas fa-file-pdf'></i> <label>PDF</label>
                    </a>
                </li>
                <li class="" role="">
                    <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/epub/crunchy_containers.epub" target="_blank" rel="noopener">
                      <i class='fas fa-book'></i> <label>EPUB</label>
                    </a>
                </li>
        </nav>
        <hr>

      <b>Navigation</b>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/">Overview</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/overview/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/overview/">
            Container Images
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/supported/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/overview/supported/">
            Supported Platforms
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/">Client User Guide</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/user-guide/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/user-guide/">
            User Guide
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/usage/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/client-user-guide/usage/">
            Using the Images
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/" class="dd-item parent haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/">Examples</a>
            <i class="fas fa-angle-down fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/primary/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/primary/">
            PostgreSQL Primary
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/custom-config/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/custom-config/">
            Custom Configuration of PostgreSQL Container
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/custom-config-ssl/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/custom-config-ssl/">
            Custom Configuration of PostgreSQL Container with SSL
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/primary-replica/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/primary-replica/">
            Primary and Streaming Replica Containers
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/sync-replica/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/sync-replica/">
            Synchronous Replication
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/postgis/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/postgresql/postgis/">
            PostGIS Container
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/poolers/pgpool/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/poolers/pgpool/">
            pgPool II
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgbackrest/" class="dd-item active">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgbackrest/">
            pgBackRest
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgbasebackup/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgbasebackup/">
            pgBaseBackup
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgdump-pgrestore/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgdump-pgrestore/">
            pgDump &amp; pgRestore
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/poolers/pgbouncer/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/poolers/pgbouncer/">
            pgBouncer
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/metrics/pgbadger/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/metrics/pgbadger/">
            pgBadger
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/metrics/pgbench/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/metrics/pgbench/">
            pgBench
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/logging/centralized-logging/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/logging/centralized-logging/">
            Centralized Logging
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/logging/pgaudit/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/logging/pgaudit/">
            pgAudit
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/administration/upgrade/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/administration/upgrade/">
            Upgrade
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/administration/pgadmin4/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/administration/pgadmin4/">
            pgAdmin 4
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/">Installation Guide</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/installation-guide/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/installation-guide/">
            Installation Guide
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/storage-configuration/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/installation-guide/storage-configuration/">
            Storage Configuration
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/">Container Specifications</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgadmin4/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgadmin4/">
            crunchy-pgadmin4
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbackrest/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbackrest/">
            crunchy-pgbackrest
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbackrest-repo/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbackrest-repo/">
            crunchy-pgbackrest-repo
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbadger/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbadger/">
            crunchy-pgbadger
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbouncer/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgbouncer/">
            crunchy-pgbouncer
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgpool/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-pgpool/">
            crunchy-pgpool
          </a>
        </div>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/">crunchy-postgres</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/postgres/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/postgres/">
            postgres
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/backup/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/backup/">
            backup
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgbasebackup-restore/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgbasebackup-restore/">
            pgbasebackup-restore
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgbench/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgbench/">
            pgbench
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgdump/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgdump/">
            pgdump
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgrestore/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/pgrestore/">
            pgrestore
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/sqlrunner/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres/sqlrunner/">
            sqlrunner
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres-gis/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres-gis/">
            crunchy-postgres-gis
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-upgrade/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-upgrade/">
            crunchy-upgrade
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/" class="dd-item haschildren
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/">Contributing</a><i class="fas fa-angle-right fa-lg category-icon"></i>

      </div>
        <ul>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/building/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/building/">
            Building the Containers
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/issues/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/issues/">
            Submitting Issues
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/pull-requests/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/pull-requests/">
            Submitting Pull Requests
          </a>
        </div>
    </li>
      <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/documentation-updates/" class="dd-item">
        <div>
          <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/documentation-updates/">
            
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://crunchydata.github.io/crunchy-containers/4.7.7/troubleshooting/" class="dd-item
        ">
      <div>
      <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/troubleshooting/">Troubleshooting</a>

      </div>
    </li>




      <hr><nav id="TableOfContents"></nav>



      <section>
      </section>
    </ul>
  </aside>
  <section class="page">

    <div class="nav-select">
      <center>Navigation :
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/overview/" >
   Overview</option>
    <option value="/client-user-guide/" >
   Client User Guide</option>
    <option value="/examples/" >
   Examples</option> 
      <option value="/examples/postgresql/primary/" >- PostgreSQL Primary</option>
      <option value="/examples/postgresql/custom-config/" >- Custom Configuration of PostgreSQL Container</option>
      <option value="/examples/postgresql/custom-config-ssl/" >- Custom Configuration of PostgreSQL Container with SSL</option>
      <option value="/examples/postgresql/primary-replica/" >- Primary and Streaming Replica Containers</option>
      <option value="/examples/postgresql/sync-replica/" >- Synchronous Replication</option>
      <option value="/examples/postgresql/postgis/" >- PostGIS Container</option>
      <option value="/examples/poolers/pgpool/" >- pgPool II</option>
      <option value="/examples/backup-restoration/pgbackrest/"  selected>- pgBackRest</option>
      <option value="/examples/backup-restoration/pgbasebackup/" >- pgBaseBackup</option>
      <option value="/examples/backup-restoration/pgdump-pgrestore/" >- pgDump &amp; pgRestore</option>
      <option value="/examples/poolers/pgbouncer/" >- pgBouncer</option>
      <option value="/examples/metrics/pgbadger/" >- pgBadger</option>
      <option value="/examples/metrics/pgbench/" >- pgBench</option>
      <option value="/examples/logging/centralized-logging/" >- Centralized Logging</option>
      <option value="/examples/logging/pgaudit/" >- pgAudit</option>
      <option value="/examples/administration/upgrade/" >- Upgrade</option>
      <option value="/examples/administration/pgadmin4/" >- pgAdmin 4</option>
  
    <option value="/installation-guide/" >
   Installation Guide</option>
    <option value="/container-specifications/" >
   Container Specifications</option>
    <option value="/contributing/" >
   Contributing</option>
    <option value="/troubleshooting/" >
   Troubleshooting</option>



        </select>
      </center>
    </div>

    
      <div id="top-bar">
        
          
          
          
        <div id="top-github-link">
          <a class="github-link" href="https://crunchydata.github.io/crunchy-containers/4.7.7/contributing/" target="blank">
            <i class="fa fa-info-circle"></i>
            
          </a>
          <a class="github-link" href="https://github.com/CrunchyData/crunchy-containers/edit/master/docs/content/examples/backup-restoration/pgbackrest.md" target="blank">
            <i class="fa fa-code-fork"></i>
            
          </a>
        </div><div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                <i class="fa fa-bars"></i>
              </a>
            </span>
            <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
            <span class="links">
            







 <a href='https://crunchydata.github.io/crunchy-containers/4.7.7/'>Introduction</a> > <a href='https://crunchydata.github.io/crunchy-containers/4.7.7/examples/'>Examples</a> > pgBackRest

 

 


            </span>
        </div>

      </div>
    

    
    <div id="body-inner">

    <h1>pgBackRest</h1>

    

    
    

<h1 id="pgbackrest-examples">pgBackRest Examples</h1>

<p>Written and maintained by David Steele, pgBackRest is a utility that provides backup and restore functionality for PostgreSQL databases.  pgBackRest is available for use within the Crunchy Container Suite, and can therefore be utilized to provide an effective backup and restore solution for any database clusters deployed using the crunchy-postgres or crunchy-postgres-gis containers.  The following section will provide an overview of how pgBackRest can be utilized within the Crunchy Container Suite, including examples for enabling and configuring pgBackRest, and then utilizing pgBackRest to backup and restore various PostgreSQL database clusters.  For more detailed information about pgBackRest, please visit the <a href="https://pgbackrest.org/">official pgBackRest website</a>.</p>

<h2 id="configuration-overview">Configuration Overview</h2>

<p>In order to enable pgBackRest within a crunchy-postgres or crunchy-postgres-gis container, environment variable <code>PGBACKREST</code> must be set to <code>true</code> during deployment of the container (<code>PGBACKREST=true</code>).  This will setup the proper pgBackRest configuration, ensure any required pgBackRest repositories and directories are created, and will create the proper pgBackRest stanza.</p>

<p>Please note that setting <code>PGBACKREST=true</code> is all that is needed to configure and enable pgBackRest within a crunchy-postgres or crunchy-postgres-gis container.  When enabled, default environment variables will be set for pgBackRest as follows, unless they are otherwise explicitly defined and provided during deployment of the container:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">export</span> <span style="color:#111">PGBACKREST_STANZA</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;db&#34;</span>
<span style="color:#111">export</span> <span style="color:#111">PGBACKREST_PG1_PATH</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;/pgdata/</span><span style="color:#d88200">${</span><span style="color:#111">PGDATA_DIR</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>
<span style="color:#111">export</span> <span style="color:#111">PGBACKREST_REPO1_PATH</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;/backrestrepo/</span><span style="color:#d88200">${</span><span style="color:#111">PGDATA_DIR</span><span style="color:#d88200">}</span><span style="color:#d88200">-backups&#34;</span>
<span style="color:#111">export</span> <span style="color:#111">PGBACKREST_LOG_PATH</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;/tmp&#34;</span></code></pre></div>
<p>As shown above, a stanza named <code>db</code> is created by default, using the default values provided for both <code>PGBACKREST_PG1_PATH</code> and <code>PGBACKREST_REPO1_PATH</code>.  Variable <code>PGDATA_DIR</code> represents the name of the database cluster&rsquo;s data directory, which will either be the hostname of the container or the value specified for variable <code>PGDATA_PATH_OVERRIDE</code> during deployment of the container.  Please see the <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres">crunchy-postgres</a> and/or <a href="https://crunchydata.github.io/crunchy-containers/4.7.7/container-specifications/crunchy-postgres-gis">crunchy-postgres-gis</a> container specifications for additional details.</p>

<p>While setting <code>PGBACKREST</code> to <code>true</code> provides a simple method for enabling pgBackRest within a crunchy-postgres or crunchy-postgres-gis container, pgBackRest is also fully configurable and customizable via the various environment variables supported by pgBackRest.  This applies to the crunchy-backrest-restore container as well, which is also configured using pgBackRest environment variables when performing database restores.  Therefore, during the deployment of any container container containing pgBackRest (crunchy-postgres, crunchy-postgres-gis or crunchy-backrest-restore), environment variables should be utilized to configure and customize the pgBackRest utility as needed and ensure the desired backup and restore functionality is achieved.  For instance, the following environment variables could be specified upon deployment of the crunchy-backrest-restore container in order to perform delta restore to a specific point-in-time:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_TYPE</span><span style="color:#f92672">=</span><span style="color:#111">time</span>
<span style="color:#111">PITR_TARGET</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;2019-10-27 16:53:05.590156+00&#34;</span>
<span style="color:#111">PGBACKREST_DELTA</span><span style="color:#f92672">=</span>y</code></pre></div>
<p>Database restores can be performed via the crunchy-backrest-restore container, which offers full pgBackRest restore capabilities, such as full, point-in-time and delta restores.  Further information and guidance for performing both backups and restores using the Crunchy Container Suite and pgBackRest will be provided in the examples below.</p>

<p>In addition to providing the backup and restoration capabilities discussed above, pgBackRest supports the capability to asynchronously push and get write ahead logs (WAL) to and from a WAL archive.  To enable asychronous WAL archiving within a crunchy-postgres or crunchy-postgres-gis container, pgBackRest environment variable <code>PGBACKREST_ARCHIVE_ASYNC</code> must be set to <code>&quot;y&quot;</code> during deployment (<code>PGBACKREST_ARCHIVE_ASYNC=y</code>).  This will automatically enable WAL archiving within the container if not otherwise explicitly enabled, set the proper <code>pgbackrest archive</code> command within the <code>postgresql.conf</code> configuration file, and ensure the proper spool path has been created.</p>

<p>If a spool path is not explicitly provided using environment variable <code>PGBACKREST_SPOOL_PATH</code>, this variable will default as follows:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Environment variable XLOGDIR=&#34;true&#34;</span>
<span style="color:#111">export</span> <span style="color:#111">PGBACKREST_SPOOL_PATH</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;/pgdata/</span><span style="color:#d88200">${</span><span style="color:#111">PGDATA_DIR</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>

<span style="color:#75715e"># Environment variable XLOGDIR!=true</span>
<span style="color:#111">export</span> <span style="color:#111">PGBACKREST_SPOOL_PATH</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;/pgwal/</span><span style="color:#d88200">${</span><span style="color:#111">PGDATA_DIR</span><span style="color:#d88200">}</span><span style="color:#d88200">/spool&#34;</span></code></pre></div>
<p>As shown above, the default location of the spool path depends on whether or not <code>XLOGDIR=true</code>, with <code>XLOGDIR</code> enabling the storage of WAL to the <code>/pgwal</code> volume within the container.  Being that pgBackRest recommends selecting a spool path that is as close to the WAL as possible, this provides a sensible default for the spool directory.  However, <code>PGBACKREST_SPOOL_PATH</code> can also be explicitly configured during deployment to any path desired.  And once again, <code>PGDATA_DIR</code> represents either the hostname of the container or the value specified for variable <code>PGDATA_PATH_OVERRIDE</code>.</p>

<p>The examples below will demonstrate the pgBackRest backup, restore and asynchronous archiving capabilities described above, while also providing insight into the proper configuration of pgBackBackrest within the Crunchy Container Suite.  For more information on these pgBackRest capabilities and associated configuration, please consult the <a href="https://pgbackrest.org/">official pgBackRest documentation</a>.</p>

<h2 id="kubernetes-and-openshift">Kubernetes and OpenShift</h2>

<p><strong><em>The pgBackRest examples for Kubernetes and OpenShift can be configured to use the PostGIS images by setting the following environment variable when running the examples:</em></strong></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">export</span> <span style="color:#111">CCP_PG_IMAGE</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;-gis&#39;</span></code></pre></div>
<h3 id="backup">Backup</h3>

<p>In order to demonstrate the backup and restore capabilities provided by pgBackRest, it is first necessary to deploy a PostgreSQL database, and then create a full backup of that database.  This example will therefore deploy a crunchy-postgres or crunchy-postgres-gis container containing a PostgreSQL database, which will then be backed up manually by executing a <code>pgbackrest backup</code> command.  <strong><em>Please note that this example serves as a prequisite for the restore examples that follow, and therefore must be run prior to running those examples.</em></strong></p>

<p>Start the example as follows:</p>

<pre><code>cd $CCPROOT/examples/kube/backrest/backup
./run.sh
</code></pre>

<p>This will create the following in your Kubernetes environment:</p>

<ul>
<li>A deployment named <strong>backrest</strong> containing a PostgreSQL database with pgBackRest configured</li>
<li>A service named <strong>backrest</strong> for the PostgreSQL database</li>
<li>A PV and PVC for the PGDATA directory</li>
<li>A PV and PVC for the pgBackRest backups and archives directories</li>
</ul>

<p>Once the <strong>backrest</strong> deployment is running, use the <code>pgbackrest info</code> command to verify that pgbackrest has been properly configured and WAL archiving is working properly:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- pgbackrest info <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-backups

<span style="color:#111">pg_pid</span><span style="color:#f92672">=</span><span style="color:#ae81ff">126</span>
stanza: db
    status: error <span style="color:#f92672">(</span>no valid backups<span style="color:#f92672">)</span>
    cipher: none

    db <span style="color:#f92672">(</span>current<span style="color:#f92672">)</span>
        wal archive min/max <span style="color:#f92672">(</span><span style="color:#ae81ff">11</span>-1<span style="color:#f92672">)</span>: <span style="color:#ae81ff">000000010000000000000001</span> / <span style="color:#ae81ff">000000010000000000000003</span></code></pre></div>
<p>An output similar to the above indicates that pgBackRest was properly configured upon deployment of the pod, the <strong>db</strong> stanza has been created, and WAL archiving is working properly.  The error next to <strong>status</strong> is expected being that a backup has not yet been generated.</p>

<p>Now that we have verified that pgBackRest is properly configured and enabled, a backup of the database can be generated.  Being that this is the first backup of the database, we will take create a <strong>full</strong> backup:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>full

<span style="color:#111">pg_pid</span><span style="color:#f92672">=</span><span style="color:#ae81ff">138</span>
WARN: option repo1-retention-full is not set, the repository may run out of space
      HINT: to retain full backups indefinitely <span style="color:#f92672">(</span>without warning<span style="color:#f92672">)</span>, <span style="color:#111">set</span> option <span style="color:#d88200">&#39;repo1-retention-full&#39;</span> to the maximum.</code></pre></div>
<p>The warning displayed is expected, since backup retention has not been configured for this example.  Assuming no errors are displayed, a full backup has now been successfully created.</p>

<h3 id="restore">Restore</h3>

<p>pgBackRest provides numerous methods and strategies for restoring a PostgreSQL database.  The following section will demonstrate  three forms of database restores that can be  accomplished when using pgBackRest with the Crunchy Container Suite:</p>

<ul>
<li><strong>Full:</strong> restore all database files into an empty PGDATA directory</li>
<li><strong>point-in-time Recovery (PITR):</strong> restore a database to a specific point-in-time using an empty PGDATA directory</li>
<li><strong>Delta:</strong> restore a database to a specific point-in-time using an existing PGDATA directory</li>
</ul>

<h4 id="full">Full</h4>

<p>This example will demonstrate a full database restore to an empty PGDATA directory.  <strong><em>Please ensure the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the full restore, we will first make a change to the currently running database, which will we will then verify still exists following the restore.  Create a simple table in the database as follows:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Now verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the full restore as follows:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/full
./run.sh</code></pre></div>
<p>This will create the following in your Kubernetes environment:</p>

<ul>
<li>A Kubernetes job named <strong>backrest-full-restore-job</strong> which will perform the restore using the crunchy-backrest-restore container</li>
<li>A PV and PVC for the new PGDATA directory that will contain the restored database.  The directory will initially be empty, as required  pgBackRest when performing a full restore, and will then contain the restored database upon completion of the restore.</li>
</ul>

<p>Please note that a brand new PV and PVC are created when running the restore to clearly indicate that the database will be restored into an entirely new (i.e. empty) volume as required by pgBackRest.  The names of the new PV and PVC are as follows:</p>

<ul>
<li><strong>PV:</strong> ${CCP_NAMESPACE}-br-new-pgdata</li>
<li><strong>PVC:</strong> br-new-pgdata</li>
</ul>

<p>You can verify that the restore has completed successfully by verifying that the Kubernetes job has completed successfully:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> get <span style="color:#111">jobs</span>
NAME                        COMPLETIONS   DURATION   AGE
backrest-full-restore-job   <span style="color:#ae81ff">1</span>/1           15s        58s</code></pre></div>
<p>Once the job is complete, the post restore script can then be run, which will create a new deployment named <strong>backrest-full-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/full
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-full-restored</strong> deployment is running we can verify that the restore was successful by verifying that the table created prior to the restore still exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest restored pod name&gt; -- psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>Please note that the default behavior of pgBackRest is to recover to the end of the WAL archive stream, which is why the full restore contained all changes made since the initial full backup was taken, including the creation of table <strong>backrest_test_table</strong>.  pgBackRest therefore played the entire WAL archive stream for all changes that occurred up until the restore.</p>

<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h4 id="pitr">PITR</h4>

<p>As demonstrated with the full restore above, the default behavior of pgBackRest is to recover to the end of the WAL archive stream. However, pgBackRest also provides the ability to recover to a specific point-in-time utilizing the WAL archives created since the last backup. This example will demonstrate how pgBackRest can be utilized to perform a point-in-time recovery (PITR) and therefore recover the database to specific point-in-time specified by the user.  <strong><em>Please ensure that the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the PITR restore, we will first verify the current state of the database, after which we will then make a change to the database.  This will allow us to verify that the PITR is successful by providing a method of verifying that the database has been restored to its current state following the restore.</p>

<p>To verify the current state of the database, we will first verify that a table called <strong>backrest_test_table</strong> does not  exist in the database.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34; table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p>Next, capture the current timestamp, which will be used later in the example when performing the restore:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;select current_timestamp&#34;</span>
       current_timestamp
-------------------------------
 <span style="color:#ae81ff">2019</span>-10-27 <span style="color:#ae81ff">16</span>:53:05.590156+00
<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> row<span style="color:#f92672">)</span></code></pre></div>
<p>Now create table <strong>backrest_test_table</strong>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Then verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the PITR.  However, the timestamp captured above must also be provided in order to instruct pgBackRest to recover to that specific point-in-time.  This is done using the <code>CCP_BACKREST_TIMESTAMP</code> variable, which allows us to then start the PITR as follows (replace the timestamp in the command below with the timestamp you captured above):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/pitr
<span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;2019-10-27 16:53:05.590156+00&#34;</span> ./run.sh</code></pre></div>
<p>This will create the following in your Kubernetes environment:
- A Kubernetes job named <strong>backrest-pitr-restore-job</strong> which will perform the restore using the crunchy-backrest-restore container</p>

<p>Additionally, when this example is run, the following pgBackRest environment variables are provided to the crunchy-backrest-restore container in order to initiate PITR restore to the point-in-time specified by the timestamp (in additional to any other pgBackRest variables required by the Crunchy Container Suite and pgBackRest):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_TYPE</span><span style="color:#f92672">=</span><span style="color:#111">time</span>
<span style="color:#111">PITR_TARGET</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;</span><span style="color:#d88200">${</span><span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span></code></pre></div>
<p>As can be seen above, the timestamp provided for <code>CCP_BACKREST_TIMESTAMP</code> is used to populate variable <code>PITR_TARGET</code>, and therefore specify the point-in-time to restore the database to, while <code>PGBACKREST_TYPE</code> is set to <code>time</code> to indicate that a PITR should be performed.</p>

<p>Please note that the following pgBackRest environment variable is also set when performing the PITR, which results in a restore to a new/empty directory within an existing PV:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_PG1_PATH</span><span style="color:#f92672">=</span>/pgdata/backrest-pitr-restored</code></pre></div>
<p>You can verify that the restore has completed successfully by verifying that the Kubernetes job has completed successfully:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> get <span style="color:#111">jobs</span>
NAME                        COMPLETIONS   DURATION   AGE
backrest-pitr-restore-job   <span style="color:#ae81ff">1</span>/1           15s        58s</code></pre></div>
<p>Once the job is complete, the post restore script can then be run, which will create a new deployment named <strong>backrest-pitr-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/pitr
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-pitr-restored</strong> deployment is running we can verify that the restore was successful by verifying that the table created prior to the restore no longer exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest restored pod name&gt; -- psql -c <span style="color:#d88200">&#34; table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h4 id="delta">Delta</h4>

<p>By default, pgBackRest requires a clean/empty directory in order to perform a restore.  However, pgBackRest also provides an another option when performing the restore in the form of the <strong>delta</strong> option, which allows the restore to be run against an existing PGDATA directory.  With the delta option enabled, pgBackRest will use checksums to determine which files in the directory can be preserved, and which need to be restored (please note that pgBackRest will also remove any files that are not present in the backup).  This example will again demonstrate a point-in-time recovery (PITR), only this time the restore will occur within the existing PGDATA directory by specifying the <strong>delta</strong> option during the restore. <strong><em>Please ensure that the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the delta restore, we will first verify the current state of the database, and we will then make a change to the database.  This will allow us to verify that the delta restore is successful by providing a method of verifying that the database has been restored to its current state following the restore.</p>

<p>To verify the current state of the database, we will first verify that a table called <strong>backrest_test_table</strong> does not exist in the database.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34; table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p>Next, capture the current timestamp, which will be used later in the example when performing the restore:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;select current_timestamp&#34;</span>
       current_timestamp
-------------------------------
 <span style="color:#ae81ff">2019</span>-10-27 <span style="color:#ae81ff">16</span>:53:05.590156+00
<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> row<span style="color:#f92672">)</span></code></pre></div>
<p>Now create table <strong>backrest_test_table</strong>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Then verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest pod name&gt; -- psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the delta restore.  When running the restore example the timestamp captured above must also be provided in order to instruct pgBackRest to recover to that specific point-in-time.  This is done using the <code>CCP_BACKREST_TIMESTAMP</code> variable, which allows us to then start the delta restore as follows (replace the timestamp in the command below with the timestamp you captured above):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/delta
<span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;2019-10-27 16:53:05.590156+00&#34;</span> ./run.sh</code></pre></div>
<p>This will create the following in your Kubernetes environment:
- A Kubernetes job named <strong>backrest-delta-restore-job</strong> which will perform the restore using the crunchy-backrest-restore container</p>

<p>Additionally, when this example is run, the following pgBackRest environment variables are provided to the crunchy-backrest-restore container in order to initiate a delta restore to the point-in-time specified by the timestamp (in additional to any other pgBackRest variables required by the Crunchy Container Suite and pgBackRest):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_TYPE</span><span style="color:#f92672">=</span><span style="color:#111">time</span>
<span style="color:#111">PITR_TARGET</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;</span><span style="color:#d88200">${</span><span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>
<span style="color:#111">PGBACKREST_DELTA</span><span style="color:#f92672">=</span>y</code></pre></div>
<p>As can be seen above, the timestamp provided for <code>CCP_BACKREST_TIMESTAMP</code> is used to populate variable <code>PITR_TARGET</code>, and therefore specify the point-in-time to restore to, while <code>PGBACKREST_TYPE</code> is set to <code>time</code> to indicate that a PITR should be performed. <code>PGBACKREST_DELTA</code> is set to <code>y</code> to indicate that the delta option should be utilized when performing the restore.</p>

<p>It&rsquo;s also worth noting that the following pgBackRest environment variable is also set when performing the delta restore, which results in a restore within the existing PGDATA directory utilized by the database deployed when running the <strong>Backup</strong> example:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_PG1_PATH</span><span style="color:#f92672">=</span>/pgdata/backrest</code></pre></div>
<p>You can then verify that the restore has completed successfully by verifying that the Kubernetes job has completed successfully:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> get <span style="color:#111">jobs</span>
NAME                        COMPLETIONS   DURATION   AGE
backrest-delta-restore-job   <span style="color:#ae81ff">1</span>/1           15s        58s</code></pre></div>
<p>Once the job is complete, the post restore script can then be run, which will create a new deployment named <strong>backrest-delta-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/kube/backrest/delta
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-delta-restored</strong> deployment is running we can verify that the restore was successful by verifying that the table created prior to the restore no longer exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest restored pod name&gt; -- psql -c <span style="color:#d88200">&#34; table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h3 id="async-archiving">Async Archiving</h3>

<p>pgBackRest supports the capability to asynchronously push and get write ahead logs (WAL) to and from a WAL archive. Asynchronous archiving can improve performance by parallelizing operations, while also reducing the number of connections to remote storage. For more information on async archiving and its benefits, please see the <a href="https://pgbackrest.org/">official pgBackRest documentation</a>.  This example will demonstrate how asynchronous archiving can be enabled within a crunchy-postgres or crunchy-postgres-gis container, while then also demonstrating the creation of a differential backup.</p>

<p>Start the example as follows:</p>

<pre><code>cd $CCPROOT/examples/kube/backrest/async-archiving
./run.sh
</code></pre>

<p>This will create the following in your Kubernetes environment:
- A deployment named <strong>backrest-async-archive</strong> containing a PostgreSQL database with pgBackRest configured
- A service named <strong>backrest-async-archive</strong> for the PostgreSQL database
- A PV and PVC for the PGDATA directory
- A PV and PVC for the pgBackRest backups and archives directories</p>

<p>Additionally, the following variable will be set during deployment of the pod in order to enable asynchronous archiving:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_ARCHIVE_ASYNC</span><span style="color:#f92672">=</span>y</code></pre></div>
<p>This will also result in the creation of the required spool path, which we can see by listing the contents of the <code>/pgdata</code> directory in the backrest-async-archive deployment:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest async archive pod name&gt; -- ls /pgdata
backrest-async-archive
backrest-async-archive-backups
backrest-async-archive-spool</code></pre></div>
<p>Once the database is up an running, a full backup can be taken:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest async archive pod name&gt; -- pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest-async-archive <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>full</code></pre></div>
<p>And once a full backup has been taken, other types of backups can also be taken using pgBackRest, such as a differential backup:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest async archive pod name&gt; -- pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest-async-archive <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>diff</code></pre></div>
<p>The following command can then be run to verify that both backups were created successfully:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#d88200">${</span><span style="color:#111">CCP_CLI</span><span style="color:#d88200">}</span> <span style="color:#111">exec</span> &lt;backrest async archive pod name&gt; -- pgbackrest info <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups</code></pre></div>
<h2 id="docker">Docker</h2>

<h3 id="backup-1">Backup</h3>

<p>In order to demonstrate the backup and restore capabilities provided by pgBackRest, it is first necessary to deploy a PostgreSQL database, and then create a full backup of that database.  This example will therefore deploy a crunchy-postgres or crunchy-postgres-gis container containing a PostgreSQL database, which will then be backed up manually by executing a <code>pgbackrest backup</code> command.  <strong><em>Please note that this example serves as a prequisite for the restore examples that follow, and therefore must be run prior to running those examples.</em></strong></p>

<p>Start the example as follows:</p>

<pre><code>cd $CCPROOT/examples/docker/backrest/backup
./run.sh
</code></pre>

<p>This will create the following in your Docker environment:
- A container named <strong>backrest</strong> containing a PostgreSQL database with pgBackRest configured
- A volume for the PGDATA directory
- A volume for the pgBackRest backups and archives directories</p>

<p>Once the <strong>backrest</strong> container is running, use the <code>pgbackrest info</code> command to verify that pgbackrest has been properly configured and WAL archiving is working properly:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest pgbackrest info <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-backups

<span style="color:#111">pg_pid</span><span style="color:#f92672">=</span><span style="color:#ae81ff">126</span>
stanza: db
    status: error <span style="color:#f92672">(</span>no valid backups<span style="color:#f92672">)</span>
    cipher: none

    db <span style="color:#f92672">(</span>current<span style="color:#f92672">)</span>
        wal archive min/max <span style="color:#f92672">(</span><span style="color:#ae81ff">11</span>-1<span style="color:#f92672">)</span>: <span style="color:#ae81ff">000000010000000000000001</span> / <span style="color:#ae81ff">000000010000000000000003</span></code></pre></div>
<p>An output similar to the above indicates that pgBackRest was properly configured upon deployment of the container, the <strong>db</strong> stanza has been created, and WAL archiving is working properly.  The error next to <strong>status</strong> is expected being that a backup has not yet been generated.</p>

<p>Now that we have verified that pgBackRest is properly configured and enabled, a backup of the database can be generated.  Being that this is the first backup of the database, we will take create a <strong>full</strong> backup:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>full

<span style="color:#111">pg_pid</span><span style="color:#f92672">=</span><span style="color:#ae81ff">138</span>
WARN: option repo1-retention-full is not set, the repository may run out of space
      HINT: to retain full backups indefinitely <span style="color:#f92672">(</span>without warning<span style="color:#f92672">)</span>, <span style="color:#111">set</span> option <span style="color:#d88200">&#39;repo1-retention-full&#39;</span> to the maximum.</code></pre></div>
<p>The warning displayed is expected, since backup retention has not been configured for this example.  Assuming no errors are displayed, a full backup has now been successfully created.</p>

<h3 id="restore-1">Restore</h3>

<p>pgBackRest provides numerous methods and strategies for restoring a PostgreSQL database.  The following section will demonstrate  three forms of database restores that can be  accomplished when using pgBackRest with the Crunchy Container Suite:
- <strong>Full:</strong> restore all database files into an empty PGDATA directory
- <strong>point-in-time Recovery (PITR):</strong> restore a database to a specific point-in-time using an empty PGDATA directory
- <strong>Delta:</strong> restore a database to a specific point-in-time using an existing PGDATA directory</p>

<h4 id="full-1">Full</h4>

<p>This example will demonstrate a full database restore to an empty PGDATA directory.  <strong><em>Please ensure the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the full restore, we will first make a change to the currently running database, which will we will then verify still exists following the restore.  Create a simple table in the database as follows:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Now verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the full restore as follows:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/full
./run.sh</code></pre></div>
<p>This will create the following in your Docker environment:
- A container named <strong>backrest-full-restore</strong> which will perform the restore using the crunchy-backrest-restore container
- A volume for the new PGDATA directory that will contain the restored database.  The directory will initially be empty, as required  pgBackRest when performing a full restore, and will then contain the restored database upon completion of the restore.</p>

<p>Please note that a brand new PV and PVC are created when running the restore to clearly indicate that the database will be restored into an entirely new (i.e. empty) volume as required by pgBackRest.  The names of the new PV and PVC are as follows:
- <strong>PV:</strong> ${CCP_NAMESPACE}-br-new-pgdata
- <strong>PVC:</strong> br-new-pgdata</p>

<p>You can verify that the restore has completed successfully by verifying that the container has finished running and has exited without errors:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker ps -a</code></pre></div>
<p>Once the container has finished running, the post restore script can then be run, which will create a new container named <strong>backrest-full-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/full
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-full-restored</strong> container is running we can verify that the restore was successful by verifying that the table created prior to the restore still exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest-full-restored psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>Please note that the default behavior of pgBackRest is to recover to the end of the WAL archive stream, which is why the full restore contained all changes made since the initial full backup was taken, including the creation of table <strong>backrest_test_table</strong>.  pgBackRest therefore played the entire WAL archive stream for all changes that occurred up until the restore.</p>

<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h4 id="pitr-1">PITR</h4>

<p>As demonstrated with the full restore above, the default behavior of pgBackRest is to recover to the end of the WAL archive stream. However, pgBackRest also provides the ability to recover to a specific point-in-time utilizing the WAL archives created since the last backup. This example will demonstrate how pgBackRest can be utilized to perform a point-in-time recovery (PITR) and therefore recover the database to specific point-in-time specified by the user.  <strong><em>Please ensure that the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the PITR restore, we will first verify the current state of the database, after which we will then make a change to the database.  This will allow us to verify that the PITR is successful by providing a method of verifying that the database has been restored to its current state following the restore.</p>

<p>To verify the current state of the database, we will first verify that a table called <strong>backrest_test_table</strong> does not  exist in the database.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p>Next, capture the current timestamp, which will be used later in the example when performing the restore:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;select current_timestamp&#34;</span>
       current_timestamp
-------------------------------
 <span style="color:#ae81ff">2019</span>-10-27 <span style="color:#ae81ff">16</span>:53:05.590156+00
<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> row<span style="color:#f92672">)</span></code></pre></div>
<p>Now create table <strong>backrest_test_table</strong>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Then verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the PITR.  However, the timestamp captured above must also be provided in order to instruct pgBackRest to recover to that specific point-in-time.  This is done using the <code>CCP_BACKREST_TIMESTAMP</code> variable, which allows us to then start the PITR as follows (replace the timestamp in the command below with the timestamp you captured above):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/pitr
<span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;2019-10-27 16:53:05.590156+00&#34;</span> ./run.sh</code></pre></div>
<p>This will create the following in your Docker environment:
- A container named <strong>backrest-pitr-restore</strong> which will perform the restore using the crunchy-backrest-restore container</p>

<p>Additionally, when this example is run, the following pgBackRest environment variables are provided to the crunchy-backrest-restore container in order to initiate PITR to the point-in-time specified by the timestamp (in additional to any other pgBackRest variables required by the Crunchy Container Suite and pgBackRest):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_TYPE</span><span style="color:#f92672">=</span><span style="color:#111">time</span>
<span style="color:#111">PITR_TARGET</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;</span><span style="color:#d88200">${</span><span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span></code></pre></div>
<p>As can be seen above, the timestamp provided for <code>CCP_BACKREST_TIMESTAMP</code> is used to populate variable <code>PITR_TARGET</code>, and therefore specify the point-in-time to restore the database to, while <code>PGBACKREST_TYPE</code> is set to <code>time</code> to indicate that a PITR should be performed.</p>

<p>Please note that the following pgBackRest environment variable is also set when performing the PITR, which results in a restore to a new/empty directory within an existing PV:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_PG1_PATH</span><span style="color:#f92672">=</span>/pgdata/backrest-pitr-restored</code></pre></div>
<p>You can verify that the restore has completed successfully by verifying that the container has finished running and has exited without errors:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker ps -a</code></pre></div>
<p>Once the container has finished running, the post restore script can then be run, which will create a new container named <strong>backrest-pitr-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/pitr
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-pitr-restored</strong> container is running we can verify that the restore was successful by verifying that the table created prior to the restore no longer exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest-pitr-restored psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h4 id="delta-1">Delta</h4>

<p>By default, pgBackRest requires a clean/empty directory in order to perform a restore.  However, pgBackRest also provides an another option when performing the restore in the form of the <strong>delta</strong> option, which allows the restore to be run against an existing PGDATA directory.  With the delta option enabled, pgBackRest will use checksums to determine which files in the directory can be preserved, and which need to be restored (please note that pgBackRest will also remove any files that are not present in the backup).  This example will again demonstrate a point-in-time recovery (PITR), only this time the restore will occur within the existing PGDATA directory by specifying the <strong>delta</strong> option during the restore. <strong><em>Please ensure that the Backup example is currently running and a full backup has been generated prior to running this example.</em></strong></p>

<p>Prior to running the delta restore, we will first verify the current state of the database, and we will then make a change to the database.  This will allow us to verify that the delta restore is successful by providing a method of verifying that the database has been restored to its current state following the restore.</p>

<p>To verify the current state of the database, we will first verify that a table called <strong>backrest_test_table</strong> does not  exist in the database.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p>Next, capture the current timestamp, which will be used later in the example when performing the restore:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;select current_timestamp&#34;</span>
       current_timestamp
-------------------------------
 <span style="color:#ae81ff">2019</span>-10-27 <span style="color:#ae81ff">16</span>:53:05.590156+00
<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> row<span style="color:#f92672">)</span></code></pre></div>
<p>Now create table <strong>backrest_test_table</strong>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;create table backrest_test_table (id int)&#34;</span>
CREATE TABLE</code></pre></div>
<p>Then verify that the new table exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
 id
----
<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> rows<span style="color:#f92672">)</span></code></pre></div>
<p>With the table in place, we can now start the delta restore.  When running the restore example the timestamp captured above must also be provided in order to instruct pgBackRest to recover to that specific point-in-time.  This is done using the <code>CCP_BACKREST_TIMESTAMP</code> variable, which allows us to then start the delta restore as follows (replace the timestamp in the command below with the timestamp you captured above):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/delta
<span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;2019-10-27 16:53:05.590156+00&#34;</span> ./run.sh</code></pre></div>
<p>This will create the following in your Docker environment:
- A container named <strong>backrest-delta-restore</strong> which will perform the restore using the crunchy-backrest-restore container</p>

<p>Additionally, when this example is run, the following pgBackRest environment variables are provided to the crunchy-backrest-restore container in order to initiate a delta restore to the point-in-time specified by the timestamp (in additional to any other pgBackRest variables required by the Crunchy Container Suite and pgBackRest):</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_TYPE</span><span style="color:#f92672">=</span><span style="color:#111">time</span>
<span style="color:#111">PITR_TARGET</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;</span><span style="color:#d88200">${</span><span style="color:#111">CCP_BACKREST_TIMESTAMP</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span>
<span style="color:#111">PGBACKREST_DELTA</span><span style="color:#f92672">=</span>y</code></pre></div>
<p>As can be seen above, the timestamp provided for <code>CCP_BACKREST_TIMESTAMP</code> is used to populate variable <code>PITR_TARGET</code>, and therefore specify the point-in-time to restore to, while <code>PGBACKREST_TYPE</code> is set to <code>time</code> to indicate that a PITR should be performed. <code>PGBACKREST_DELTA</code> is set to <code>y</code> to indicate that the delta option should be utilized when performing the restore.</p>

<p>It&rsquo;s also worth noting that the following pgBackRest environment variable is also set when performing the delta restore, which results in a restore within the existing PGDATA directory utilized by the database deployed when running the <strong>Backup</strong> example:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_PG1_PATH</span><span style="color:#f92672">=</span>/pgdata/backrest</code></pre></div>
<p>You can verify that the restore has completed successfully by verifying that the container has finished running and has exited without errors:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker ps -a</code></pre></div>
<p>Once the container has finished running, the post restore script can then be run, which will create a new container named <strong>backrest-delta-restored</strong> containing the restored database:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">cd</span> <span style="color:#111">$CCPROOT</span>/examples/docker/backrest/delta
./post-restore.sh</code></pre></div>
<p>Finally, once the <strong>backrest-delta-restored</strong> container is running we can verify that the restore was successful by verifying that the table created prior to the restore no longer exists:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest-delta-restored psql -c <span style="color:#d88200">&#34;table backrest_test_table&#34;</span>
ERROR:  relation <span style="color:#d88200">&#34;backrest_test_table&#34;</span> does not exist
LINE <span style="color:#ae81ff">1</span>:  table backrest_test_table
               ^
<span style="color:#111">command</span> terminated with <span style="color:#111">exit</span> code <span style="color:#ae81ff">1</span></code></pre></div>
<p><em>As a reminder, please remember to run the cleanup script for the <strong>Backup</strong> example after running the cleanup script for this example.</em></p>

<h3 id="async-archiving-1">Async Archiving</h3>

<p>pgBackRest supports the capability to asynchronously push and get write ahead logs (WAL) to and from a WAL archive. Asynchronous archiving can improve performance by parallelizing operations, while also reducing the number of connections to remote storage. For more information on async archiving and its benefits, please see the <a href="https://pgbackrest.org/">official pgBackRest documentation</a>.  This example will demonstrate how asynchronous archiving can be enabled within a crunchy-postgres or crunchy-postgres-gis container, while then also demonstrating the creation of a differential backup.</p>

<p>Start the example as follows:</p>

<pre><code>cd $CCPROOT/examples/docker/backrest/async-archive
./run.sh
</code></pre>

<p>This will create the following in your Docker environment:</p>

<ul>
<li>A container named <strong>backrest-async-archive</strong> containing a PostgreSQL database with pgBackRest configured</li>
<li>A volume for the PGDATA directory</li>
<li>A volume for the pgBackRest backups and archives directories</li>
</ul>

<p>Additionally, the following variable will be set during deployment of the container in order to enable asynchronous archiving:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#111">PGBACKREST_ARCHIVE_ASYNC</span><span style="color:#f92672">=</span>y</code></pre></div>
<p>This will also result in the creation of the required spool path, which we can see by listing the contents of the <code>/pgdata</code> directory in the backrest-async-archive container:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#111">exec</span> backrest-async-archive ls /pgdata
backrest-async-archive
backrest-async-archive-backups
backrest-async-archive-spool</code></pre></div>
<p>Once the database is up an running, a full backup can be taken:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker <span style="color:#111">exec</span> backrest-async-archive pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest-async-archive <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>full</code></pre></div>
<p>And once a full backup has been taken, other types of backups can also be taken using pgBackRest, such as a differential backup:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker <span style="color:#111">exec</span> backrest-async-archive pgbackrest backup <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --pg1-path<span style="color:#f92672">=</span>/pgdata/backrest-async-archive <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --log-path<span style="color:#f92672">=</span>/tmp <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --type<span style="color:#f92672">=</span>diff</code></pre></div>
<p>The following command can then be run to verify that both backups were created successfully:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker <span style="color:#111">exec</span> backrest-async-archive pgbackrest info <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --stanza<span style="color:#f92672">=</span>db <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --repo1-path<span style="color:#f92672">=</span>/backrestrepo/backrest-async-archive-backups</code></pre></div>


    
      <div class="chevrons">
  <div id="navigation">
<a class="nav nav-prev" href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/poolers/pgpool/" title="pgPool II"> <i class="fa fa-chevron-left"></i><label>pgPool II</label></a>
    <a class="nav nav-next" href="https://crunchydata.github.io/crunchy-containers/4.7.7/examples/backup-restoration/pgbasebackup/" title="pgBaseBackup" style="margin-right: 0px;"><label>pgBaseBackup</label><i class="fa fa-chevron-right"></i></a></div>
</div>

</section>
</article>

<footer>

<div class="footline">
  

  



</div>


<div>
</div>

<div class="text-center">
  <p><small>&copy; 2017 - 2022 Crunchy Data Solutions, Inc.</small></p>
</div>


</footer>

<link href="https://crunchydata.github.io/crunchy-containers/4.7.7/css/featherlight.min.css" rel="stylesheet">
<script src="https://crunchydata.github.io/crunchy-containers/4.7.7/js/featherlight.min.js"></script>

<script src="https://crunchydata.github.io/crunchy-containers/4.7.7/theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>
